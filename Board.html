<html>
<head>
	<title>KiChess</title>
</head>

<style>

	table{
		width: 800px;
		height: 800px;
		border: 2px solid black; 
	}
	
	td{
		position: relative;
		padding: 0; 
		margin: 0;
		width: 12.5%;
		height: 12.5%;
		top: 0;
		left: 0;
	}
	
	img
	{
		position: absolute;
		top: 0;
		left: 0;
	}

	.overlay{
		position: absolute;
		opacity: 0.5;
		top: 0;	
		left: 0;
	}

	.blacksquare {
		background-color: #5c3f2e;
	}

	.whitesquare {
		background-color: #ffffb0;
	}

</style>

<script type="text/javascript">

	var gamestate = "RNBKQBNR;PPPPPPPP;________;________;________;________;pppppppp;rnbkqbnr;";
	var extendedState = {
		"isWhitesTurn": true,
		"whiteACastleable": true,
		"whiteHCastleable": true,
		"blackACastleable": true,
		"blackHCastleable": true,
		"EnpassanablePawn": false,
		"StateRepetitionCounter": {}
	}
	
	var gameMetaData = {
		"isWhiteHuman": true,
		"isBlackHuman": true
	}
	
	function getLegalMoves(coordinate){
		
		var piece = getPiece(coordinate);
		
		
		
		// TODO
		return [];
	
	}
	
	function markLegalMoves(coord){
	
		// Mark the newly selected square.
		var currentSquare = document.getElementById(coord);	
		currentSquare.innerHTML = '<img src="assets/SelectedSquare.png" class="overlay" height = 97px width = 97px style = "opacity:1.0" >' +  currentSquare.innerHTML; // Show green selection
		
		getLegalMoves(coord);
		// TODO:
	}
	
	function getPiece(coordinate){

		var columnIndex = coordinate[0].charCodeAt(0) - 97; // Col is given by leading letter. Convert this to integer from 0-7
		var columnState = gamestate.split(";")[coordinate[1] - 1]; 
		
		var cellContent = columnState[columnIndex];      
		
		console.log("At coordinate: " + coordinate + " there is a " + cellContent );
		
		return cellContent;
	}
	
	var previouslySelectedSquare = null;
	function selectSquare(coord){
	
		console.log("clicked on " + coord);
		if( gameMetaData.isWhitesTurn & (! extendedState.isWhiteHuman)){ console.log("White to play. Waiting for CPU"); return;} 
		if( gameMetaData.isBlacksTurn & (! extendedState.isBlackHuman)){ console.log("Black to play. Waiting for CPU"); return;} 		
		
		if(previouslySelectedSquare == null){
		
			var newSelectedPiece = getPiece(coord);
			if(newSelectedPiece == '_'){		
				console.log("Selected empty square, nothing to do");
				return;
			}
			if(extendedState.isWhitesTurn && ! (newSelectedPiece != newSelectedPiece.toLowerCase())){		
				console.log("// white tried to select their opponent's piece");
				return;
			}			
			if(extendedState.isWhitesTurn && ! (newSelectedPiece != newSelectedPiece.toLowerCase())){		
				console.log("// black tried to select their opponent's piece");
				return;
			}
			
			markLegalMoves(coord);
			previouslySelectedSquare = coord;
			
		}else{
			
			// Given that you have a currently selected piece:
				// if you clicked on another square and that is a legal move, then perform the move.
				// else, select the new piece
			
			// Clear previous overlay
			const elements = document.getElementsByClassName("overlay");
			while (elements.length > 0) elements[0].remove();
			
			// Validate legal moves
			var legalMoves = getLegalMoves(previouslySelectedSquare);
			
			if(legalMoves.includes(coord)){
				
				// TODO: Process Move
	
				
			}else{
				// Not a move. Instead, just select the new piece (via recursive call) 
				previouslySelectedSquare = null;
				selectSquare(coord);
			}
		}
	}
	
	function startGame(){
		// Caps is black, lower case for white pieces. N = knight, K = king.
		var startingState = "RNBKQBNR;PPPPPPPP;________;________;________;________;pppppppp;rnbkqbnr;"
		setGameToState(startingState);

	}
	
	function setGameToState(startingState){
	
		var rows = startingState.split(';');
		
		var chessBoard = document.getElementsByTagName("td");
		console.log(chessBoard.id);
		
		var x = 0;
		for (const row of rows) {		
			for( const cell of row.split('')){
					
				if( cell == 'R' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/rook.png" height = 100px width = 100px >' } 
				if( cell == 'N' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/knight.png" height = 100px width = 100px >' } 
				if( cell == 'B' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/bishop.png" height = 100px width = 100px >' } 
				if( cell == 'K' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/king.png" height = 100px width = 100px >' } 
				if( cell == 'Q' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/queen.png" height = 100px width = 100px >' } 
				if( cell == 'P' ){ chessBoard[x].innerHTML = '<img src="assets/blackPieces/pawn.png" height = 100px width = 100px >' } 
				
				if( cell == 'r' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/rook.png" height = 100px width = 100px >' } 
				if( cell == 'n' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/knight.png" height = 100px width = 100px >' } 
				if( cell == 'b' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/bishop.png" height = 100px width = 100px >' } 
				if( cell == 'k' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/king.png" height = 100px width = 100px >' } 
				if( cell == 'q' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/queen.png" height = 100px width = 100px >' } 
				if( cell == 'p' ){ chessBoard[x].innerHTML = '<img src="assets/whitePieces/pawn.png" height = 100px width = 100px >' } 
			
				x++
			}
		}
	}

</script>
<body>	
	<table>
	 	<table>
	  <tr>
		<td id="a8" onclick = selectSquare("a8") class="blacksquare"></td>
		<td id="b8" onclick = selectSquare("b8") class="whitesquare"></td>
		<td id="c8" onclick = selectSquare("c8") class="blacksquare"></td>
		<td id="d8" onclick = selectSquare("d8") class="whitesquare"></td>
		<td id="e8" onclick = selectSquare("e8") class="blacksquare"></td>
		<td id="f8" onclick = selectSquare("f8") class="whitesquare"></td>
		<td id="g8" onclick = selectSquare("g8") class="blacksquare"></td>
		<td id="h8" onclick = selectSquare("h8") class="whitesquare"></td>
	  </tr>  
	  <tr>
		<td id="a7" onclick = selectSquare("a7") class="whitesquare"></td>
		<td id="b7" onclick = selectSquare("b7") class="blacksquare"></td>
		<td id="c7" onclick = selectSquare("c7") class="whitesquare"></td>
		<td id="d7" onclick = selectSquare("d7") class="blacksquare"></td>
		<td id="e7" onclick = selectSquare("e7") class="whitesquare"></td>
		<td id="f7" onclick = selectSquare("f7") class="blacksquare"></td>
		<td id="g7" onclick = selectSquare("g7") class="whitesquare"></td>
		<td id="h7" onclick = selectSquare("h7") class="blacksquare"></td>
	  </tr>  
	  <tr>
		<td id="a6" onclick = selectSquare("a6") class="blacksquare"></td>
		<td id="b6" onclick = selectSquare("b6") class="whitesquare"></td>
		<td id="c6" onclick = selectSquare("c6") class="blacksquare"></td>
		<td id="d6" onclick = selectSquare("d6") class="whitesquare"></td>
		<td id="e6" onclick = selectSquare("e6") class="blacksquare"></td>
		<td id="f6" onclick = selectSquare("f6") class="whitesquare"></td>
		<td id="g6" onclick = selectSquare("g6") class="blacksquare"></td>
		<td id="h6" onclick = selectSquare("h6") class="whitesquare"></td>
	  </tr>  
	  <tr>
		<td id="a5" onclick = selectSquare("a5") class="whitesquare"></td>
		<td id="b5" onclick = selectSquare("b5") class="blacksquare"></td>
		<td id="c5" onclick = selectSquare("c5") class="whitesquare"></td>
		<td id="d5" onclick = selectSquare("d5") class="blacksquare"></td>
		<td id="e5" onclick = selectSquare("e5") class="whitesquare"></td>
		<td id="f5" onclick = selectSquare("f5") class="blacksquare"></td>
		<td id="g5" onclick = selectSquare("g5") class="whitesquare"></td>
		<td id="h5" onclick = selectSquare("h5") class="blacksquare"></td>
	  </tr>  
	  <tr>
		<td id="a4" onclick = selectSquare("a4") class="blacksquare"></td>
		<td id="b4" onclick = selectSquare("b4") class="whitesquare"></td>
		<td id="c4" onclick = selectSquare("c4") class="blacksquare"></td>
		<td id="d4" onclick = selectSquare("d4") class="whitesquare"></td>
		<td id="e4" onclick = selectSquare("e4") class="blacksquare"></td>
		<td id="f4" onclick = selectSquare("f4") class="whitesquare"></td>
		<td id="g4" onclick = selectSquare("g4") class="blacksquare"></td>
		<td id="h4" onclick = selectSquare("h4") class="whitesquare"></td>
	  </tr>  
	  <tr>
		<td id="a3" onclick = selectSquare("a3") class="whitesquare"></td>
		<td id="b3" onclick = selectSquare("b3") class="blacksquare"></td>
		<td id="c3" onclick = selectSquare("c3") class="whitesquare"></td>
		<td id="d3" onclick = selectSquare("d3") class="blacksquare"></td>
		<td id="e3" onclick = selectSquare("e3") class="whitesquare"></td>
		<td id="f3" onclick = selectSquare("f3") class="blacksquare"></td>
		<td id="g3" onclick = selectSquare("g3") class="whitesquare"></td>
		<td id="h3" onclick = selectSquare("h3") class="blacksquare"></td>
	  </tr>  
	  <tr>
		<td id="a2" onclick = selectSquare("a2") class="blacksquare"></td>
		<td id="b2" onclick = selectSquare("b2") class="whitesquare"></td>
		<td id="c2" onclick = selectSquare("c2") class="blacksquare"></td>
		<td id="d2" onclick = selectSquare("d2") class="whitesquare"></td>
		<td id="e2" onclick = selectSquare("e2") class="blacksquare"></td>
		<td id="f2" onclick = selectSquare("f2") class="whitesquare"></td>
		<td id="g2" onclick = selectSquare("g2") class="blacksquare"></td>
		<td id="h2" onclick = selectSquare("h2") class="whitesquare"></td>
	  </tr>  
	  <tr>
		<td id="a1" onclick = selectSquare("a1") class="whitesquare"></td>
		<td id="b1" onclick = selectSquare("b1") class="blacksquare"></td>
		<td id="c1" onclick = selectSquare("c1") class="whitesquare"></td>
		<td id="d1" onclick = selectSquare("d1") class="blacksquare"></td>
		<td id="e1" onclick = selectSquare("e1") class="whitesquare"></td>
		<td id="f1" onclick = selectSquare("f1") class="blacksquare"></td>
		<td id="g1" onclick = selectSquare("g1") class="whitesquare"></td>
		<td id="h1" onclick = selectSquare("h1") class="blacksquare"></td>
	  </tr>
	</table>

	<button onclick="startGame()" > Start Game </button>

</body>
</html>